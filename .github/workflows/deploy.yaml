name: Build and Atomic Deploy to VM

on:
  push:
    branches: [ "main" ]

env:
  REMOTE_BASE: /var/www          # <- change if you use a different base
  SITE_NAME: main                # <- will create /var/www/releases/main and /var/www/main symlink

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'            # change if needed
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build site
        run: npm run build             # must output build to ./dist

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          # known hosts to avoid interactive prompt
          if [ -n "${{ secrets.KNOWN_HOSTS }}" ]; then
            echo "${{ secrets.KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          else
            ssh-keyscan -p ${{ secrets.SSH_PORT || '22' }} ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
          fi

      - name: Create release name
        id: release
        run: |
          ts=$(date -u +"%Y%m%d%H%M%S")
          echo "RELEASE_DIR=releases/${{ env.SITE_NAME }}/$ts" >> $GITHUB_ENV
          echo "RELEASE_SYMLINK=${{ env.SITE_NAME }}" >> $GITHUB_ENV

      - name: Rsync built files to new release dir on server
        env:
          SSH_PORT: ${{ secrets.SSH_PORT }}
          SSH_HOST: ${{ secrets.SSH_HOST }}
          SSH_USER: ${{ secrets.SSH_USER }}
        run: |
          set -e
          # remote target path (create parent dir if missing)
          remote_parent="${{ env.REMOTE_BASE }}/releases/${{ env.SITE_NAME }}"
          ssh -p ${SSH_PORT:-22} -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes $SSH_USER@$SSH_HOST "mkdir -p $remote_parent"
          # rsync dist/ to a timestamped folder (we use the value from previous step)
          remote_dir="${{ env.REMOTE_BASE }}/$RELEASE_DIR"
          rsync -az --delete -e "ssh -p ${SSH_PORT:-22} -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=yes" ./dist/ \
            $SSH_USER@$SSH_HOST:$remote_dir/

      - name: Activate new release (atomic swap) on server
        uses: appleboy/ssh-action@v0.1.8
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            set -e
            REMOTE_BASE="${{ env.REMOTE_BASE }}"
            SITE="${{ env.SITE_NAME }}"
            RELEASE_DIR="$REMOTE_BASE/$RELEASE_DIR"
            LIVE_LINK="$REMOTE_BASE/$SITE"

            # Create releases dir if missing (safety)
            mkdir -p "$(dirname "$RELEASE_DIR")"
            if [ ! -d "$RELEASE_DIR" ]; then
              echo "Release folder $RELEASE_DIR not found!"
              exit 1
            fi

            # Optional: keep only last 5 releases
            ls -1dt "$REMOTE_BASE/releases/$SITE"/* 2>/dev/null | sed -n '6,$p' | xargs -r rm -rf --

            # Atomically update symlink
            ln -sfn "$RELEASE_DIR" "$LIVE_LINK"

            # Set ownership to deploy user (optional, ensures webserver can read)
            chown -R ${{ secrets.SSH_USER }}:${{ secrets.SSH_USER }} "$RELEASE_DIR" || true

            # If you serve static files via nginx, you might want to restart/reload or clear cache
            # Example: sudo systemctl reload nginx  (requires deploy user to have sudo without password)
            # sudo systemctl reload nginx || true

      - name: Deployment complete
        run: echo "Deployed to ${{ secrets.SSH_HOST }}:$RELEASE_DIR and symlinked to /var/www/${{ env.SITE_NAME }}"
